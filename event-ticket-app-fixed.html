<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#9333ea">
    <title>M√∂lndals Festv√•ning - Evenemangsbiljetter</title>
    <!-- <link rel="manifest" href="manifest.json"> --> <!-- Inaktiverad f√∂r lokal anv√§ndning -->
    <!-- Emoji Font Fix f√∂r Android -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Emoji Font Support f√∂r alla element */
        *, button, input, textarea, select {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'Noto Color Emoji', sans-serif;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'Noto Color Emoji', sans-serif;
            background: linear-gradient(135deg, #faf5ff 0%, #ffffff 50%, #eef2ff 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 40px 0;
        }

        .header-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 32px;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .header p {
            color: #6b7280;
            font-size: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid #f3f4f6;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-purple {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            color: white;
        }

        .card-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .card-green {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .card-orange {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .card-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .view-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }

        .back-btn {
            color: #9333ea;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .back-btn:active {
            background: #f3e8ff;
        }

        .event-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 2px solid #f3f4f6;
        }

        .event-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .event-icon {
            font-size: 50px;
        }

        .event-info h3 {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .event-detail {
            font-size: 14px;
            color: #6b7280;
            margin: 5px 0;
        }

        .event-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .event-price {
            font-size: 28px;
            font-weight: bold;
            color: #9333ea;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px; /* iOS touch target minimum */
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: #9333ea;
            color: white;
        }

        .btn-primary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            transition: border 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #9333ea;
        }

        .info-box {
            background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%);
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
        }

        .info-box h3 {
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box ol {
            list-style: none;
            color: #374151;
            font-size: 14px;
            line-height: 1.8;
        }

        .info-box li {
            margin: 8px 0;
        }

        .ticket-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 2px solid #e5e7eb;
        }

        .ticket-card.checked-in {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .ticket-header {
            padding: 25px;
        }

        .ticket-title {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .ticket-title h3 {
            font-size: 18px;
            color: #1f2937;
        }

        .badge {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            font-weight: 600;
            color: #22c55e;
        }

        .ticket-divider {
            border-top: 2px dashed #e5e7eb;
            margin: 20px 0;
        }

        .ticket-qr {
            background: white;
            border: 4px solid #1f2937;
            border-radius: 12px;
            padding: 30px;
            padding-bottom: 80px;
            text-align: center;
            margin-bottom: 100px;
            min-height: 450px;
        }

        .qr-container {
            display: inline-block;
            padding: 20px;
            background: white;
            min-height: 320px;
        }

        .qr-container img {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .qr-placeholder {
            font-size: 120px;
            color: #1f2937;
        }

        .qr-code {
            font-size: 11px;
            font-family: monospace;
            color: #6b7280;
            margin: 10px 0;
            word-break: break-all;
        }

        .qr-instruction {
            font-size: 14px;
            font-weight: 600;
            color: #9333ea;
            margin-top: 10px;
        }

        /* === STATISTIK & RAPPORTER === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stats-table {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stats-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #e5e7eb;
            color: #1f2937;
            font-weight: 600;
        }

        .stats-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .stats-table tr:hover {
            background: #f9fafb;
        }

        /* === KATEGORI-FILTER === */
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .category-btn {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .category-btn:hover {
            border-color: #9333ea;
            color: #9333ea;
            transform: translateY(-2px);
        }

        .category-btn.active {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            color: white;
            border-color: #9333ea;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }

        .category-btn:active {
            transform: scale(0.95);
        }

        .event-category-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* === BILJETTYPER === */
        .ticket-type-selector {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .ticket-type-selector h3 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .ticket-type-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .ticket-type-card:hover {
            border-color: #9333ea;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.2);
            transform: translateY(-2px);
        }

        .ticket-type-card.selected {
            border-color: #9333ea;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }

        .ticket-type-icon {
            font-size: 36px;
            min-width: 50px;
            text-align: center;
        }

        .ticket-type-info {
            flex: 1;
        }

        .ticket-type-name {
            font-weight: 600;
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .ticket-type-desc {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .ticket-type-price {
            font-size: 22px;
            font-weight: bold;
            color: #9333ea;
            margin-bottom: 4px;
        }

        .ticket-type-available {
            font-size: 11px;
            color: #22c55e;
            font-weight: 600;
        }

        .ticket-type-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }


        .scanner-box {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-radius: 20px;
            padding: 50px 30px;
            text-align: center;
            color: white;
            margin-bottom: 25px;
        }

        #qr-reader {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
        }

        #qr-reader video {
            width: 100%;
            border-radius: 12px;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .camera-controls button {
            flex: 1;
        }

        .scanner-icon {
            font-size: 100px;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .search-box input {
            flex: 1;
        }

        .result-box {
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-top: 25px;
        }

        .result-success {
            background: #f0fdf4;
            border: 4px solid #22c55e;
        }

        .result-error {
            background: #fef2f2;
            border: 4px solid #ef4444;
        }

        .result-icon {
            font-size: 70px;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .result-success .result-title {
            color: #166534;
        }

        .result-error .result-title {
            color: #991b1b;
        }

        .result-details {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }

        .stat-box {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-number {
            font-size: 40px;
            font-weight: bold;
        }

        .stat-icon {
            font-size: 60px;
            opacity: 0.5;
        }

        .guest-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #22c55e;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .guest-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .guest-event {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .guest-contact {
            font-size: 12px;
            color: #9ca3af;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 80px;
            color: #d1d5db;
            margin-bottom: 20px;
        }

        .empty-text {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .demo-box {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 20px;
            padding: 25px;
            margin-top: 25px;
        }

        .demo-box h3 {
            color: #1f2937;
            margin-bottom: 15px;
        }

        .demo-btn {
            width: 100%;
            background: white;
            border: 2px solid #93c5fd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
        }

        .demo-btn:active {
            background: #dbeafe;
        }

        .demo-btn-title {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
        }

        .demo-btn-subtitle {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
        }

        .purchase-event {
            background: linear-gradient(135deg, #faf5ff 0%, #eef2ff 100%);
            border: 2px solid #c4b5fd;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .purchase-event-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .purchase-event h3 {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 8px;
        }

        /* === MOBILANPASSNING === */
        @media (max-width: 768px) {
            body {
                padding: 15px;
                padding-bottom: 180px;
            }

            .container {
                max-width: 100%;
            }

            .header h1 {
                font-size: 26px;
            }

            .header p {
                font-size: 14px;
            }

            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .card {
                padding: 20px 15px;
            }

            .card-icon {
                font-size: 32px;
            }

            .card-title {
                font-size: 14px;
            }

            .view-title {
                font-size: 20px;
            }

            /* Event cards */
            .event-card {
                margin-bottom: 15px;
            }

            .event-header {
                flex-direction: column;
                text-align: center;
            }

            .event-icon {
                font-size: 40px;
                margin-bottom: 10px;
            }

            .event-footer {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .event-footer button {
                width: 100%;
            }

            /* Kategori-filter */
            .category-filter {
                padding: 12px;
            }

            .category-btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            /* Biljettyper */
            .ticket-type-card {
                flex-direction: column;
                text-align: center;
            }

            .ticket-type-icon {
                font-size: 48px;
                margin-bottom: 10px;
            }

            /* Statistik */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card-box {
                padding: 20px 15px;
            }

            .stat-icon {
                font-size: 32px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-label {
                font-size: 12px;
            }

            /* QR-kod */
            .ticket-qr {
                padding: 20px;
                padding-bottom: 60px;
            }

            /* Scanner */
            #qr-reader {
                max-width: 100%;
            }

            /* Formul√§r */
            .form-group {
                margin-bottom: 15px;
            }

            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }

            /* Tabell i statistik */
            .stats-table table {
                font-size: 13px;
            }

            .stats-table th,
            .stats-table td {
                padding: 8px 6px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
                padding-bottom: 200px;
            }

            .header h1 {
                font-size: 24px;
            }

            .header-icon {
                font-size: 50px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .card {
                padding: 25px 15px;
            }

            .card-icon {
                font-size: 36px;
            }

            /* Kategori-filter scrollbar */
            .category-filter {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .category-btn {
                flex-shrink: 0;
                white-space: nowrap;
            }

            /* Event kort */
            .event-name {
                font-size: 18px;
            }

            .event-date,
            .event-location {
                font-size: 13px;
            }

            /* Statistik 1 kolumn p√• sm√• sk√§rmar */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card-box {
                padding: 25px;
            }

            /* Biljettyper stack vertikalt */
            .ticket-type-selector {
                padding: 15px;
            }

            .ticket-type-name {
                font-size: 15px;
            }

            .ticket-type-price {
                font-size: 20px;
            }

            /* QR-kod justerad f√∂r mobil */
            .qr-container {
                padding: 15px;
                min-height: 280px;
            }

            /* Mindre tabeller p√• mobil */
            .stats-table {
                overflow-x: auto;
            }

            .stats-table table {
                font-size: 12px;
                min-width: 300px;
            }

            .stats-table th,
            .stats-table td {
                padding: 6px 4px;
            }
        }

        /* Landscape mode p√• mobil */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                padding-bottom: 100px;
            }

            .header {
                padding: 20px 0;
            }

            .grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Mycket sm√• sk√§rmar */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 22px;
            }

            .card-title {
                font-size: 13px;
            }

            .stat-value {
                font-size: 20px;
            }

            .event-price {
                font-size: 20px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HOME VIEW -->
        <div id="homeView" class="view active">
            <div class="header">
                <div class="header-icon">üéüÔ∏è</div>
                <h1>M√∂lndals Festv√•ning</h1>
                <p>Boka dina evenemangsbiljetter</p>
            </div>

            <div class="grid">
                <div class="card card-purple" onclick="showView('events')">
                    <div class="card-icon">üìÖ</div>
                    <div class="card-title">K√∂p Biljetter</div>
                    <div class="card-subtitle"><span id="eventCount">0</span> event</div>
                </div>

                <div class="card card-blue" onclick="showView('myTickets')">
                    <div class="card-icon">üéüÔ∏è</div>
                    <div class="card-title">Mina Biljetter</div>
                    <div class="card-subtitle"><span id="ticketCount">0</span> biljetter</div>
                </div>

                <div class="card card-green" onclick="showView('scanner')">
                    <div class="card-icon">üì∑</div>
                    <div class="card-title">Scanna QR</div>
                    <div class="card-subtitle">Kontrollera intr√§de</div>
                </div>

                <div class="card card-orange" onclick="showView('checkin')">
                    <div class="card-icon">üë•</div>
                    <div class="card-title">Incheckade</div>
                    <div class="card-subtitle"><span id="checkinCount">0</span> g√§ster</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary" style="width: 100%;" onclick="showView('admin')">
                    ‚öôÔ∏è Hantera Event
                </button>
            </div>

            <div style="margin-top: 10px;">
                <button class="btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="showView('stats'); renderStats();">
                    üìä Visa Statistik
                </button>
            </div>

            <div class="info-box">
                <h3>Hur det fungerar</h3>
                <ol>
                    <li><strong>1.</strong> V√§lj event och k√∂p biljett</li>
                    <li><strong>2.</strong> F√• QR-kod via e-post</li>
                    <li><strong>3.</strong> Visa QR-kod vid ankomst</li>
                    <li><strong>4.</strong> Personal scannar och sl√§pper in</li>
                </ol>
            </div>
        </div>

        <!-- EVENTS VIEW -->
        <div id="eventsView" class="view">
            <div class="view-header">
                <div class="view-title">Kommande Event</div>
                <div class="back-btn" onclick="showView('home')">Tillbaka</div>
            </div>

            <!-- KATEGORI FILTER -->
            <div class="category-filter">
                <button class="category-btn active" onclick="filterByCategory('all', event)" data-category="all">
                    Alla
                </button>
                <button class="category-btn" onclick="filterByCategory('party', event)" data-category="party">
                    Fester
                </button>
                <button class="category-btn" onclick="filterByCategory('concert', event)" data-category="concert">
                    Konserter
                </button>
                <button class="category-btn" onclick="filterByCategory('conference', event)" data-category="conference">
                    Konferens
                </button>
                <button class="category-btn" onclick="filterByCategory('sports', event)" data-category="sports">
                    Sport
                </button>
                <button class="category-btn" onclick="filterByCategory('family', event)" data-category="family">
                    Familj
                </button>
                <button class="category-btn" onclick="filterByCategory('food', event)" data-category="food">
                    Mat
                </button>
                <button class="category-btn" onclick="filterByCategory('culture', event)" data-category="culture">
                    Kultur
                </button>
            </div>

            <div id="eventsList"></div>
        </div>

        <!-- PURCHASE VIEW -->
        <div id="purchaseView" class="view">
            <div class="view-header">
                <div class="view-title">K√∂p Biljett</div>
                <div class="back-btn" onclick="showView('events')">Tillbaka</div>
            </div>

            <div id="selectedEventInfo" class="purchase-event"></div>

            <!-- BILJETTYPER -->
            <div id="ticketTypeSelector" class="ticket-type-selector" style="display: none;">
                <h3>V√§lj Biljettyp</h3>
                <div id="ticketTypesContainer"></div>
            </div>

            <div class="event-card">
                <h3 style="margin-bottom: 20px;">V√§lj antal personer</h3>

                <div class="form-group">
                    <label class="form-label">üë® Antal Vuxna</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button class="btn" style="padding: 10px 20px; background: #e5e7eb;" onclick="changeQuantity('adults', -1)">-</button>
                        <span id="adultsCount" style="font-size: 24px; font-weight: bold; min-width: 40px; text-align: center;">1</span>
                        <button class="btn" style="padding: 10px 20px; background: #e5e7eb;" onclick="changeQuantity('adults', 1)">+</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">üí∞ Pris per Vuxen (kr) *</label>
                    <input type="number" id="customAdultPrice" class="form-input" placeholder="450" min="0" oninput="updatePurchasePrices()">
                </div>

                <div class="form-group">
                    <label class="form-label">üë∂ Antal Barn</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button class="btn" style="padding: 10px 20px; background: #e5e7eb;" onclick="changeQuantity('children', -1)">-</button>
                        <span id="childrenCount" style="font-size: 24px; font-weight: bold; min-width: 40px; text-align: center;">0</span>
                        <button class="btn" style="padding: 10px 20px; background: #e5e7eb;" onclick="changeQuantity('children', 1)">+</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">üí∞ Pris per Barn (kr) *</label>
                    <input type="number" id="customChildPrice" class="form-input" placeholder="250" min="0" oninput="updatePurchasePrices()">
                </div>

                <div style="background: #f3f4f6; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">Totalt:</span>
                        <span style="font-size: 28px; font-weight: bold; color: #9333ea;"><span id="totalPrice">0</span> kr</span>
                    </div>
                </div>

                <div style="background: #eff6ff; border: 2px solid #3b82f6; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="isPaidCheckbox" checked style="width: 24px; height: 24px; cursor: pointer;">
                        <span style="font-size: 16px; font-weight: 600; color: #1f2937;">
                            üí≥ Markera som BETALD
                        </span>
                    </label>
                    <p style="font-size: 13px; color: #6b7280; margin-top: 8px; margin-left: 34px;">
                        Bocka ur om betalning sker vid entr√©n
                    </p>
                </div>

                <h3 style="margin-bottom: 20px;">Kunduppgifter</h3>

                <div class="form-group">
                    <label class="form-label">üë§ F√∂rnamn *</label>
                    <input type="text" id="firstName" class="form-input" placeholder="Ange ditt f√∂rnamn">
                </div>

                <div class="form-group">
                    <label class="form-label">üë§ Efternamn *</label>
                    <input type="text" id="lastName" class="form-input" placeholder="Ange ditt efternamn">
                </div>

                <div class="form-group">
                    <label class="form-label">üìß E-post *</label>
                    <input type="email" id="email" class="form-input" placeholder="din@email.com">
                </div>

                <div class="form-group">
                    <label class="form-label">üì± Mobilnummer *</label>
                    <input type="tel" id="phone" class="form-input" placeholder="070-123 45 67">
                </div>

                <button class="btn btn-primary" style="width: 100%; font-size: 16px;" onclick="purchaseTicket()">
                    Slutf√∂r k√∂p - <span id="purchasePrice">0</span> kr
                </button>

                <p style="text-align: center; font-size: 12px; color: #6b7280; margin-top: 15px;">
                    Bekr√§ftelse skickas till din e-post och mobilnummer
                </p>
            </div>
        </div>

        <!-- MY TICKETS VIEW -->
        <div id="myTicketsView" class="view">
            <div class="view-header">
                <div class="view-title">Mina Biljetter</div>
                <div class="back-btn" onclick="showView('home')">Tillbaka</div>
            </div>

            <div id="ticketsList"></div>
        </div>

        <!-- SCANNER VIEW -->
        <div id="scannerView" class="view">
            <div class="view-header">
                <div class="view-title">Scanna Biljett</div>
                <div class="back-btn" onclick="showView('home'); stopScanner();">Tillbaka</div>
            </div>

            <div class="camera-controls">
                <button class="btn btn-primary" id="startCameraBtn" onclick="startScanner()">
                    üì∑ Starta Kamera
                </button>
                <button class="btn" id="stopCameraBtn" onclick="stopScanner()" style="background: #ef4444; color: white; display: none;">
                    ‚èπÔ∏è Stoppa
                </button>
            </div>

            <div id="qr-reader" style="display: none;"></div>

            <div id="scannerPlaceholder" class="scanner-box">
                <div class="scanner-icon">üì∑</div>
                <p style="margin-bottom: 8px;">Scanna QR-kod</p>
                <p style="font-size: 14px; opacity: 0.7;">Tryck p√• "Starta Kamera" f√∂r att b√∂rja</p>
            </div>

            <div class="event-card">
                <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    üîç Manuell s√∂kning
                </h3>
                <div class="search-box">
                    <input type="text" id="searchQuery" class="form-input" placeholder="Biljett-ID, e-post eller telefon">
                    <button class="btn btn-primary" onclick="searchTicket()">S√∂k</button>
                </div>
            </div>

            <div id="demoButtons" class="demo-box"></div>

            <div id="scanResult"></div>
        </div>

        <!-- CHECK-IN VIEW -->
        <div id="checkinView" class="view">
            <div class="view-header">
                <div class="view-title">Incheckade G√§ster</div>
                <div class="back-btn" onclick="showView('home')">Tillbaka</div>
            </div>

            <div class="stat-box">
                <div>
                    <div class="stat-number" id="totalCheckedIn">0</div>
                    <div style="font-size: 14px; opacity: 0.9;">Incheckade g√§ster</div>
                </div>
                <div class="stat-icon">üë•</div>
            </div>

            <div id="checkinList"></div>
        </div>

        <!-- STATISTIK VIEW -->
        <div id="statsView" class="view">
            <div class="view-header">
                <div class="view-title">üìä Statistik & Rapporter</div>
                <div class="back-btn" onclick="showView('home')">Tillbaka</div>
            </div>

            <!-- KPI Cards -->
            <div class="stats-grid">
                <div class="stat-card-box">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="totalRevenue">0 kr</div>
                    <div class="stat-label">Total Int√§kt</div>
                </div>
                
                <div class="stat-card-box">
                    <div class="stat-icon">üé´</div>
                    <div class="stat-value" id="totalTickets">0</div>
                    <div class="stat-label">S√•lda Biljetter</div>
                </div>
                
                <div class="stat-card-box">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-label">Unika Kunder</div>
                </div>
                
                <div class="stat-card-box">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="avgTicketPrice">0 kr</div>
                    <div class="stat-label">Snitt Biljettpris</div>
                </div>
            </div>

            <!-- Top Events Table -->
            <div class="stats-table">
                <h3 style="margin-bottom: 15px;">üèÜ Mest Popul√§ra Events</h3>
                <div id="topEventsTable"></div>
            </div>

            <!-- Export Button -->
            <button class="btn btn-primary" onclick="exportToExcel()" style="margin-top: 20px; width: 100%;">
                üì• Exportera till Excel (CSV)
            </button>
        </div>

        <!-- ADMIN VIEW -->
        <div id="adminView" class="view">
            <div class="view-header">
                <div class="view-title">Hantera Event</div>
                <div class="back-btn" onclick="showView('home')">Tillbaka</div>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-bottom: 25px;" onclick="showCreateEvent()">
                ‚ûï Skapa Nytt Event
            </button>

            <div id="createEventForm" style="display: none;" class="event-card">
                <h3 style="margin-bottom: 20px;">Skapa Event</h3>

                <div class="form-group">
                    <label class="form-label">üéâ Eventnamn *</label>
                    <input type="text" id="adminEventName" class="form-input" placeholder="t.ex. Ny√•rsfest 2026">
                </div>

                <div class="form-group">
                    <label class="form-label">üìÖ Datum *</label>
                    <input type="date" id="adminEventDate" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">‚è∞ Tid *</label>
                    <input type="time" id="adminEventTime" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">üìç Plats *</label>
                    <input type="text" id="adminEventLocation" class="form-input" placeholder="t.ex. Grand Hotel, Stockholm">
                </div>

                <div class="form-group">
                    <label class="form-label">üé≠ Emoji/Icon</label>
                    <input type="text" id="adminEventIcon" class="form-input" placeholder="üéâ" maxlength="2">
                </div>

                <div class="form-group">
                    <label class="form-label">üí∞ Pris Vuxen (kr) *</label>
                    <input type="number" id="adminPriceAdult" class="form-input" placeholder="450" min="0">
                </div>

                <div class="form-group">
                    <label class="form-label">üë∂ Pris Barn (kr) *</label>
                    <input type="number" id="adminPriceChild" class="form-input" placeholder="250" min="0">
                </div>

                <div class="form-group">
                    <label class="form-label">üé´ Tillg√§ngliga biljetter *</label>
                    <input type="number" id="adminAvailableTickets" class="form-input" placeholder="200" min="1">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="cancelCreateEvent()">
                        Avbryt
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveEvent()">
                        Spara Event
                    </button>
                </div>
            </div>

            <div id="adminEventsList" style="margin-top: 25px;"></div>
        </div>
    </div>

    <script>
        // Data
        // Event-kategorier
        const EVENT_CATEGORIES = {
            party: { name: 'Fester', icon: 'üéâ', color: '#f59e0b' },
            concert: { name: 'Konserter', icon: 'üéµ', color: '#ef4444' },
            conference: { name: 'Konferenser', icon: 'üíº', color: '#3b82f6' },
            sports: { name: 'Sport', icon: '‚öΩ', color: '#22c55e' },
            family: { name: 'Barn & Familj', icon: 'üë®‚Äçüë©‚Äçüëß', color: '#a855f7' },
            food: { name: 'Mat & Dryck', icon: 'üçΩÔ∏è', color: '#ec4899' },
            culture: { name: 'Kultur', icon: 'üé≠', color: '#6366f1' },
            other: { name: '√ñvrigt', icon: 'üìå', color: '#6b7280' }
        };

        let events;
        try {
            events = JSON.parse(localStorage.getItem('events')) || null;
        } catch (e) {
            console.warn('Kunde inte l√§sa fr√•n localStorage:', e);
            events = null;
        }
        
        // Om ingen data i localStorage, anv√§nd default events
        if (!events) {
            events = [
            {
                id: 1,
                name: 'Ny√•rsfest 2026',
                date: '2026-12-31',
                time: '20:00',
                location: 'Grand Hotel, Stockholm',
                priceAdult: 450,
                priceChild: 250,
                availableTickets: 200,
                image: 'üéâ',
                category: 'party',
                description: 'V√§lkomna det nya √•ret med stil! Festmiddag, champagne och fyrverkeri.',
                ticketTypes: [
                    {
                        id: 'standard-adult',
                        name: 'Vuxen',
                        price: 450,
                        icon: 'üë®',
                        available: 200,
                        description: 'Standardbiljett f√∂r vuxna'
                    },
                    {
                        id: 'standard-child',
                        name: 'Barn (0-12 √•r)',
                        price: 250,
                        icon: 'üë∂',
                        available: 200,
                        description: 'Barn under 12 √•r'
                    },
                    {
                        id: 'vip',
                        name: 'VIP',
                        price: 850,
                        icon: '‚≠ê',
                        available: 50,
                        description: 'VIP-lounge, fri bar, reserved seating'
                    }
                ]
            },
            {
                id: 2,
                name: 'Sommarfest',
                date: '2026-06-20',
                time: '18:00',
                location: 'Liseberg, G√∂teborg',
                priceAdult: 350,
                priceChild: 200,
                availableTickets: 150,
                image: '‚òÄÔ∏è',
                category: 'party',
                description: 'Sommarens roligaste fest med live-musik och BBQ',
                ticketTypes: [
                    {
                        id: 'standard-adult',
                        name: 'Vuxen',
                        price: 350,
                        icon: 'üë®',
                        available: 150,
                        description: 'Standardbiljett f√∂r vuxna'
                    },
                    {
                        id: 'standard-child',
                        name: 'Barn (0-12 √•r)',
                        price: 200,
                        icon: 'üë∂',
                        available: 150,
                        description: 'Barn under 12 √•r'
                    },
                    {
                        id: 'student',
                        name: 'Student',
                        price: 280,
                        icon: 'üéì',
                        available: 100,
                        description: 'Studentrabatt - Kr√§ver studentkort'
                    }
                ]
            },
            {
                id: 3,
                name: 'Jubileumsgala',
                date: '2026-03-15',
                time: '19:00',
                location: 'Konserthuset, G√∂teborg',
                priceAdult: 550,
                priceChild: 300,
                availableTickets: 100,
                image: 'üé≠',
                category: 'culture',
                description: '10-√•rs jubileum med gallamiddag och underh√•llning',
                ticketTypes: [
                    {
                        id: 'standard-adult',
                        name: 'Vuxen',
                        price: 550,
                        icon: 'üë®',
                        available: 100,
                        description: 'Standardbiljett f√∂r vuxna'
                    },
                    {
                        id: 'standard-child',
                        name: 'Barn (0-12 √•r)',
                        price: 300,
                        icon: 'üë∂',
                        available: 100,
                        description: 'Barn under 12 √•r'
                    },
                    {
                        id: 'vip',
                        name: 'VIP Premium',
                        price: 950,
                        icon: '‚≠ê',
                        available: 30,
                        description: 'VIP-bord, fri bar, meet & greet'
                    },
                    {
                        id: 'senior',
                        name: 'Senior (65+)',
                        price: 450,
                        icon: 'üë¥',
                        available: 50,
                        description: 'Seniorrabatt f√∂r 65+ √•r'
                    }
                ]
            }
        ];
        }

        let tickets, checkedInTickets;
        try {
            tickets = JSON.parse(localStorage.getItem('tickets')) || [];
            checkedInTickets = new Set(JSON.parse(localStorage.getItem('checkedInTickets')) || []);
        } catch (e) {
            console.warn('Kunde inte l√§sa tickets fr√•n localStorage:', e);
            tickets = [];
            checkedInTickets = new Set();
        }
        
        let selectedEvent = null;
        let currentCategory = 'all';
        let selectedTicketType = null;

        // Initialize
        function init() {
            updateCounts();
            renderEvents();
            renderMyTickets();
            renderCheckinList();
            renderDemoButtons();
            renderAdminEvents();
        }

        // Save to localStorage
        function saveData() {
            try {
                localStorage.setItem('tickets', JSON.stringify(tickets));
                localStorage.setItem('checkedInTickets', JSON.stringify([...checkedInTickets]));
                localStorage.setItem('events', JSON.stringify(events));
            } catch (e) {
                console.warn('Kunde inte spara till localStorage (Tracking Prevention aktiverat):', e);
                // Data sparas fortfarande i minnet f√∂r denna session
            }
        }

        // Show view
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            window.scrollTo(0, 0);
        }

        // Update counts
        function updateCounts() {
            document.getElementById('eventCount').textContent = events.length;
            document.getElementById('ticketCount').textContent = tickets.length;
            document.getElementById('checkinCount').textContent = checkedInTickets.size;
            document.getElementById('totalCheckedIn').textContent = checkedInTickets.size;
        }

        // Render events
        // === STATISTIK & RAPPORTER ===
        function calculateStats() {
            const stats = {
                totalRevenue: 0,
                totalTickets: tickets.length,
                uniqueCustomers: new Set(),
                eventStats: {},
                paymentStats: {
                    paid: 0,
                    unpaid: 0
                }
            };
            
            tickets.forEach(ticket => {
                // Total int√§kt
                const priceStr = ticket.price.toString().replace(/[^0-9]/g, '');
                const price = parseInt(priceStr) || 0;
                stats.totalRevenue += price;
                
                // Unika kunder
                stats.uniqueCustomers.add(ticket.customer.email);
                
                // Per event statistik
                if (!stats.eventStats[ticket.eventName]) {
                    stats.eventStats[ticket.eventName] = {
                        tickets: 0,
                        revenue: 0,
                        icon: ticket.eventImage || 'üéâ'
                    };
                }
                stats.eventStats[ticket.eventName].tickets++;
                stats.eventStats[ticket.eventName].revenue += price;
                
                // Betalningsstatus
                if (ticket.paid) {
                    stats.paymentStats.paid++;
                } else {
                    stats.paymentStats.unpaid++;
                }
            });
            
            stats.avgTicketPrice = stats.totalTickets > 0 
                ? Math.round(stats.totalRevenue / stats.totalTickets) 
                : 0;
            
            return stats;
        }

        function renderStats() {
            const stats = calculateStats();
            
            document.getElementById('totalRevenue').textContent = 
                stats.totalRevenue.toLocaleString('sv-SE') + ' kr';
            document.getElementById('totalTickets').textContent = 
                stats.totalTickets;
            document.getElementById('totalCustomers').textContent = 
                stats.uniqueCustomers.size;
            document.getElementById('avgTicketPrice').textContent = 
                stats.avgTicketPrice.toLocaleString('sv-SE') + ' kr';
            
            renderTopEventsTable(stats.eventStats);
        }

        function renderTopEventsTable(eventStats) {
            const sorted = Object.entries(eventStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e5e7eb;">
                            <th style="text-align: left; padding: 12px;">Event</th>
                            <th style="text-align: center; padding: 12px;">Biljetter</th>
                            <th style="text-align: right; padding: 12px;">Int√§kt</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (sorted.length === 0) {
                html += `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 30px; color: #6b7280;">
                            Inga f√∂rs√§ljningar √§nnu
                        </td>
                    </tr>
                `;
            } else {
                sorted.forEach(([name, data], index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    html += `
                        <tr style="border-bottom: 1px solid #f3f4f6;">
                            <td style="padding: 12px;">${medal} ${data.icon} ${name}</td>
                            <td style="text-align: center; padding: 12px; font-weight: 600;">${data.tickets}</td>
                            <td style="text-align: right; padding: 12px; font-weight: bold; color: #9333ea;">
                                ${data.revenue.toLocaleString('sv-SE')} kr
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table>';
            document.getElementById('topEventsTable').innerHTML = html;
        }

        function exportToExcel() {
            const stats = calculateStats();
            
            let csv = 'Event,Antal Biljetter,Total Int√§kt\n';
            Object.entries(stats.eventStats).forEach(([name, data]) => {
                csv += `"${name}",${data.tickets},${data.revenue}\n`;
            });
            
            csv += '\n===== SAMMANFATTNING =====\n';
            csv += `Total Int√§kt,${stats.totalRevenue} kr\n`;
            csv += `Totalt Antal Biljetter,${stats.totalTickets}\n`;
            csv += `Unika Kunder,${stats.uniqueCustomers.size}\n`;
            csv += `Genomsnittspris,${stats.avgTicketPrice} kr\n`;
            csv += `Betalda,${stats.paymentStats.paid}\n`;
            csv += `Obetalda,${stats.paymentStats.unpaid}\n`;
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `statistik-molndals-festvaning-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            alert('‚úÖ Statistik exporterad till CSV!');
        }

        // === KATEGORI-FILTER ===
        function filterByCategory(category, e) {
            currentCategory = category;
            
            // Uppdatera UI
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (e && e.target) {
                e.target.classList.add('active');
            }
            
            // Filtrera och rendera events
            renderEvents();
        }

        // === BILJETTYPER ===
        function selectTicketType(eventId, typeId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            selectedTicketType = event.ticketTypes.find(t => t.id === typeId);
            
            // Uppdatera UI
            document.querySelectorAll('.ticket-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            const card = document.getElementById(`ticket-type-${typeId}`);
            if (card) {
                card.classList.add('selected');
            }
            
            // S√§tt priser baserat p√• vald biljettyp
            if (selectedTicketType) {
                document.getElementById('customAdultPrice').value = selectedTicketType.price;
                document.getElementById('customChildPrice').value = Math.round(selectedTicketType.price * 0.6); // 60% f√∂r barn
                updatePurchasePrices();
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsList');
            
            // Filtrera events baserat p√• kategori
            const filtered = currentCategory === 'all' 
                ? events 
                : events.filter(e => e.category === currentCategory);
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <p class="empty-text">Inga event i denna kategori</p>
                    </div>
                `;
                return;
            }
            
            const html = filtered.map(event => {
                const category = EVENT_CATEGORIES[event.category] || EVENT_CATEGORIES.other;
                
                // Hantera b√•de nya (ticketTypes) och gamla events (priceAdult/priceChild)
                let minPrice, maxPrice, priceDisplay;
                
                if (event.ticketTypes && event.ticketTypes.length > 0) {
                    minPrice = Math.min(...event.ticketTypes.map(t => t.price));
                    maxPrice = Math.max(...event.ticketTypes.map(t => t.price));
                    priceDisplay = minPrice === 0 ? 'GRATIS' : 
                        minPrice === maxPrice ? `${minPrice} kr` : 
                        `${minPrice} - ${maxPrice} kr`;
                } else {
                    // Legacy format med priceAdult/priceChild
                    const adultPrice = event.priceAdult || 0;
                    const childPrice = event.priceChild || 0;
                    minPrice = Math.min(adultPrice, childPrice);
                    maxPrice = Math.max(adultPrice, childPrice);
                    priceDisplay = minPrice === maxPrice ? `${minPrice} kr` : 
                        `${childPrice} - ${adultPrice} kr`;
                }
                
                return `
                    <div class="event-card" style="position: relative;">
                        <div class="event-category-badge" style="background: ${category.color};">
                            ${category.icon} ${category.name}
                        </div>
                        <div class="event-header">
                            <div class="event-icon">${event.image}</div>
                            <div class="event-info">
                                <div class="event-name">${event.name}</div>
                                <div class="event-date">üìÖ ${event.date} ‚Ä¢ ‚è∞ ${event.time}</div>
                                <div class="event-location">üìç ${event.location}</div>
                                ${event.description ? `<div style="font-size: 13px; color: #6b7280; margin-top: 8px;">${event.description}</div>` : ''}
                            </div>
                        </div>
                        <div class="event-footer">
                            <div>
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Fr√•n:</div>
                                <div class="event-price">${priceDisplay}</div>
                            </div>
                            <button class="btn btn-primary" onclick="selectEvent(${event.id})">
                                Boka Nu
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // Select event
        let purchaseQuantities = { adults: 1, children: 0 };

        function selectEvent(eventId) {
            selectedEvent = events.find(e => e.id === eventId);
            purchaseQuantities = { adults: 1, children: 0 };
            selectedTicketType = null;
            
            document.getElementById('selectedEventInfo').innerHTML = `
                <div class="purchase-event-icon">${selectedEvent.image}</div>
                <h3>${selectedEvent.name}</h3>
                <div class="event-detail" style="margin: 5px 0;">${selectedEvent.date} kl. ${selectedEvent.time}</div>
                <div class="event-detail">üìç ${selectedEvent.location}</div>
            `;
            
            // Visa biljettyper
            if (selectedEvent.ticketTypes && selectedEvent.ticketTypes.length > 0) {
                renderTicketTypes();
                document.getElementById('ticketTypeSelector').style.display = 'block';
                
                // V√§lj f√∂rsta biljettypen som standard
                setTimeout(() => {
                    selectTicketType(selectedEvent.id, selectedEvent.ticketTypes[0].id);
                }, 100);
            } else {
                document.getElementById('ticketTypeSelector').style.display = 'none';
                // S√§tt standardpriser fr√•n event (legacy support)
                document.getElementById('customAdultPrice').value = selectedEvent.priceAdult || 0;
                document.getElementById('customChildPrice').value = selectedEvent.priceChild || 0;
            }
            
            updatePurchasePrices();
            showView('purchase');
        }

        function renderTicketTypes() {
            if (!selectedEvent || !selectedEvent.ticketTypes) return;
            
            let html = '';
            selectedEvent.ticketTypes.forEach(type => {
                // R√§kna redan s√•lda (om vi vill)
                const sold = tickets.filter(t => 
                    t.eventId === selectedEvent.id && t.ticketTypeId === type.id
                ).length;
                const available = type.available - sold;
                
                if (available > 0) {
                    html += `
                        <div class="ticket-type-card" id="ticket-type-${type.id}" 
                             onclick="selectTicketType(${selectedEvent.id}, '${type.id}')">
                            <div class="ticket-type-icon">${type.icon}</div>
                            <div class="ticket-type-info">
                                <div class="ticket-type-name">${type.name}</div>
                                <div class="ticket-type-desc">${type.description}</div>
                                <div class="ticket-type-price">${type.price} kr</div>
                                <div class="ticket-type-available">
                                    ${available} platser kvar
                                </div>
                                ${type.price < selectedEvent.ticketTypes[0].price ? 
                                    '<span class="ticket-type-badge">üí∞ RABATT</span>' : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('ticketTypesContainer').innerHTML = html;
        }

        function changeQuantity(type, delta) {
            if (type === 'adults') {
                purchaseQuantities.adults = Math.max(0, purchaseQuantities.adults + delta);
            } else {
                purchaseQuantities.children = Math.max(0, purchaseQuantities.children + delta);
            }
            updatePurchasePrices();
        }

        function updatePurchasePrices() {
            if (!selectedEvent) return;

            document.getElementById('adultsCount').textContent = purchaseQuantities.adults;
            document.getElementById('childrenCount').textContent = purchaseQuantities.children;

            // H√§mta priserna fr√•n input-f√§lten
            const adultPrice = parseInt(document.getElementById('customAdultPrice').value) || 0;
            const childPrice = parseInt(document.getElementById('customChildPrice').value) || 0;

            const total = (purchaseQuantities.adults * adultPrice) + 
                         (purchaseQuantities.children * childPrice);
            
            document.getElementById('totalPrice').textContent = total;
            document.getElementById('purchasePrice').textContent = total;
        }

        // Purchase ticket
        function purchaseTicket() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const isPaid = document.getElementById('isPaidCheckbox').checked;

            if (!firstName || !lastName || !email || !phone) {
                alert('‚ùå V√§nligen fyll i alla obligatoriska f√§lt');
                return;
            }

            if (!email.includes('@')) {
                alert('‚ùå Ange en giltig e-postadress');
                return;
            }

            const totalTickets = purchaseQuantities.adults + purchaseQuantities.children;
            if (totalTickets === 0) {
                alert('‚ùå V√§lj minst en biljett');
                return;
            }

            // H√§mta de angivna priserna
            const adultPrice = parseInt(document.getElementById('customAdultPrice').value) || 0;
            const childPrice = parseInt(document.getElementById('customChildPrice').value) || 0;

            if ((purchaseQuantities.adults > 0 && adultPrice === 0) || 
                (purchaseQuantities.children > 0 && childPrice === 0)) {
                alert('‚ùå V√§nligen ange pris f√∂r alla biljetttyper');
                return;
            }

            const totalPrice = (purchaseQuantities.adults * adultPrice) + 
                              (purchaseQuantities.children * childPrice);

            // Skapa en gemensam grupp-ID f√∂r alla biljetter i denna bokning
            const groupId = 'GROUP-' + Date.now();
            const paymentStatusText = isPaid ? 'BETALD' : 'OBETALD';
            const bookingInfo = {
                groupId: groupId,
                adults: purchaseQuantities.adults,
                children: purchaseQuantities.children,
                totalPersons: totalTickets,
                adultPrice: adultPrice,
                childPrice: childPrice,
                totalPrice: totalPrice,
                paid: isPaid,
                paymentStatus: paymentStatusText,
                paymentDate: isPaid ? new Date().toISOString() : null,
                customer: { firstName, lastName, email, phone },
                eventName: selectedEvent.name,
                eventDate: selectedEvent.date,
                eventTime: selectedEvent.time
            };

            // Skapa biljetter f√∂r vuxna
            for (let i = 0; i < purchaseQuantities.adults; i++) {
                const ticketId = 'T' + Date.now() + '-A' + i;
                const qrData = JSON.stringify({
                    ticketId: ticketId,
                    groupId: groupId,
                    type: 'Vuxen',
                    customer: `${firstName} ${lastName}`,
                    event: selectedEvent.name,
                    date: selectedEvent.date,
                    time: selectedEvent.time,
                    price: adultPrice,
                    totalPrice: totalPrice,
                    totalPersons: totalTickets,
                    adults: purchaseQuantities.adults,
                    children: purchaseQuantities.children,
                    email: email,
                    phone: phone,
                    paid: isPaid,
                    paymentStatus: paymentStatusText,
                    validStatus: 'GILTIG',
                    purchaseDate: new Date().toISOString()
                });
                
                const newTicket = {
                    id: ticketId,
                    groupId: groupId,
                    eventId: selectedEvent.id,
                    eventName: selectedEvent.name,
                    eventDate: selectedEvent.date,
                    eventTime: selectedEvent.time,
                    eventLocation: selectedEvent.location,
                    eventImage: selectedEvent.image,
                    customer: { firstName, lastName, email, phone },
                    purchaseDate: new Date().toISOString(),
                    qrCode: qrData,
                    ticketType: 'Vuxen',
                    price: adultPrice,
                    status: 'active',
                    paid: isPaid,
                    paymentStatus: paymentStatusText,
                    bookingInfo: bookingInfo
                };
                tickets.push(newTicket);
            }

            // Skapa biljetter f√∂r barn
            for (let i = 0; i < purchaseQuantities.children; i++) {
                const ticketId = 'T' + Date.now() + '-C' + i;
                const qrData = JSON.stringify({
                    ticketId: ticketId,
                    groupId: groupId,
                    type: 'Barn',
                    customer: `${firstName} ${lastName}`,
                    event: selectedEvent.name,
                    date: selectedEvent.date,
                    time: selectedEvent.time,
                    price: childPrice,
                    totalPrice: totalPrice,
                    totalPersons: totalTickets,
                    adults: purchaseQuantities.adults,
                    children: purchaseQuantities.children,
                    email: email,
                    phone: phone,
                    paid: isPaid,
                    paymentStatus: paymentStatusText,
                    validStatus: 'GILTIG',
                    purchaseDate: new Date().toISOString()
                });
                
                const newTicket = {
                    id: ticketId,
                    groupId: groupId,
                    eventId: selectedEvent.id,
                    eventName: selectedEvent.name,
                    eventDate: selectedEvent.date,
                    eventTime: selectedEvent.time,
                    eventLocation: selectedEvent.location,
                    eventImage: selectedEvent.image,
                    customer: { firstName, lastName, email, phone },
                    purchaseDate: new Date().toISOString(),
                    qrCode: qrData,
                    ticketType: 'Barn',
                    price: childPrice,
                    status: 'active',
                    paid: isPaid,
                    paymentStatus: paymentStatusText,
                    bookingInfo: bookingInfo
                };
                tickets.push(newTicket);
            }
            
            // Update available tickets
            const eventIndex = events.findIndex(e => e.id === selectedEvent.id);
            events[eventIndex].availableTickets -= totalTickets;

            saveData();
            updateCounts();
            renderEvents();
            renderMyTickets();
            renderDemoButtons();

            // Visa laddn indikator
            const loadingMsg = `‚è≥ Skapar ${totalTickets} biljett${totalTickets > 1 ? 'er' : ''}...\n\nSkickar till:\n${email}`;
            
            // Bekr√§ftelse
            alert(`‚úÖ ${totalTickets} biljett${totalTickets > 1 ? 'er' : ''} skapad${totalTickets > 1 ? 'e' : ''}!\n\n${purchaseQuantities.adults} Vuxen √ó ${adultPrice} kr = ${purchaseQuantities.adults * adultPrice} kr\n${purchaseQuantities.children} Barn √ó ${childPrice} kr = ${purchaseQuantities.children * childPrice} kr\n\nTotalt: ${totalPrice} kr\n\n${isPaid ? 'üí≥ ‚úÖ BETALD' : 'üí≥ ‚ùå OBETALD (Betalas vid entr√©n)'}\n\nGrupp-ID: ${groupId}\n\nüìß Skickar biljetter via e-post...`);

            // Skicka e-post f√∂r alla biljetter i gruppen (asynkront)
            setTimeout(async () => {
                let emailsSent = 0;
                const newTickets = tickets.filter(t => t.groupId === groupId);
                
                for (const newTicket of newTickets) {
                    const sent = await sendTicketEmail(newTicket);
                    if (sent) emailsSent++;
                    
                    // Liten f√∂rdr√∂jning mellan e-postutskick
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                if (emailsSent === newTickets.length) {
                    alert(`‚úÖ ${emailsSent} biljett${emailsSent > 1 ? 'er' : ''} skickad${emailsSent > 1 ? 'e' : ''} till:\n${email}\n\nKontrollera din inkorg!`);
                } else if (emailsSent > 0) {
                    alert(`‚ö†Ô∏è ${emailsSent} av ${newTickets.length} biljetter skickade.\n\nOBS: F√∂r att aktivera automatisk e-post, konfigurera EmailJS (se konsol f√∂r instruktioner).`);
                } else {
                    alert(`‚ÑπÔ∏è Biljetter skapade!\n\nüìß E-postfunktion: F√∂r att aktivera automatisk utskick, g√• till https://www.emailjs.com/ och konfigurera ditt konto.\n\nTills dess kan du ladda ner biljetterna som PDF fr√•n "Mina Biljetter".`);
                }
            }, 100);

            // Clear form
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
            purchaseQuantities = { adults: 1, children: 0 };

            showView('myTickets');
        }

        // Render my tickets
        function renderMyTickets() {
            const container = document.getElementById('ticketsList');
            
            if (tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üé´</div>
                        <p class="empty-text">Du har inga biljetter √§n</p>
                        <button class="btn btn-primary" onclick="showView('events')">K√∂p biljett</button>
                    </div>
                `;
                return;
            }

            const html = tickets.map(ticket => {
                const isCheckedIn = checkedInTickets.has(ticket.id);
                const isPaid = ticket.paid || ticket.paymentStatus === 'BETALD';
                const paymentBadgeColor = isPaid ? '#22c55e' : '#ef4444';
                const paymentBadgeBg = isPaid ? '#dcfce7' : '#fee2e2';
                const paymentText = isPaid ? '‚úÖ BETALD' : '‚ùå OBETALD';
                
                return `
                    <div class="ticket-card ${isCheckedIn ? 'checked-in' : ''}" style="border-left: 6px solid ${paymentBadgeColor};">
                        <div class="ticket-header">
                            <div class="ticket-title">
                                <div>
                                    <h3>${ticket.eventName}</h3>
                                    <div class="event-detail">${ticket.eventDate} kl. ${ticket.eventTime}</div>
                                    <div class="event-detail">üìç ${ticket.eventLocation}</div>
                                </div>
                                <div style="text-align: right;">
                                    ${isCheckedIn ? '<div class="badge" style="margin-bottom: 5px;">‚úÖ Incheckad</div>' : ''}
                                    <div style="background: ${paymentBadgeBg}; color: ${paymentBadgeColor}; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; border: 2px solid ${paymentBadgeColor};">
                                        ${paymentText}
                                    </div>
                                </div>
                            </div>

                            <div class="ticket-divider"></div>

                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div style="font-size: 14px; color: #6b7280;">
                                    <div style="font-weight: 600;">${ticket.customer.firstName} ${ticket.customer.lastName}</div>
                                    <div>${ticket.customer.email}</div>
                                    <div>${ticket.customer.phone}</div>
                                    ${ticket.ticketType ? `<div style="margin-top: 5px; font-weight: 600; color: #9333ea;">${ticket.ticketType === 'Vuxen' ? 'üë®' : 'üë∂'} ${ticket.ticketType}</div>` : ''}
                                </div>
                                <div style="text-align: right; font-size: 14px; color: #6b7280;">
                                    <div style="font-family: monospace; font-weight: bold;">${ticket.id}</div>
                                    <div style="font-size: 12px;">${new Date(ticket.purchaseDate).toLocaleDateString('sv-SE')}</div>
                                    <div style="font-weight: bold; color: #9333ea; margin-top: 5px;">${ticket.price} kr</div>
                                </div>
                            </div>

                            <div class="ticket-qr">
                                <div id="qr-${ticket.id}" class="qr-container" style="min-height: 320px; display: flex; align-items: center; justify-content: center;"></div>
                                <div class="qr-instruction" style="margin-top: 15px;">Visa denna kod vid entr√©n</div>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e5e7eb;">
                                <button class="btn" style="flex: 1; background: #10b981; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;" onclick="resendTicketEmail('${ticket.id}')">
                                    üìß Skicka E-post
                                </button>
                                <button class="btn" style="flex: 1; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;" onclick="downloadTicketPDF('${ticket.id}')">
                                    üìÑ Ladda ner
                                </button>
                                <button class="btn" style="flex: 0.6; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;" onclick="deleteTicket('${ticket.id}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;

            // Generate QR codes after rendering - with delay to ensure DOM is ready
            setTimeout(() => {
                tickets.forEach(ticket => {
                    const qrContainer = document.getElementById(`qr-${ticket.id}`);
                    if (qrContainer) {
                        // Rensa eventuellt tidigare inneh√•ll
                        qrContainer.innerHTML = '';
                        
                        try {
                            // F√∂rs√∂k med QRCode biblioteket f√∂rst
                            if (typeof QRCode !== 'undefined') {
                                new QRCode(qrContainer, {
                                    text: ticket.qrCode,
                                    width: 280,
                                    height: 280,
                                    colorDark: "#000000",
                                    colorLight: "#ffffff",
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                            } 
                            // F√∂rs√∂k med qrcode-generator biblioteket
                            else if (typeof qrcode !== 'undefined') {
                                const qr = qrcode(0, 'H');
                                qr.addData(ticket.qrCode);
                                qr.make();
                                
                                const imgTag = qr.createImgTag(8, 10); // St√∂rre cellSize fr√•n 4 till 8
                                qrContainer.innerHTML = imgTag;
                            }
                            // Fallback - generera med Google Charts API
                            else {
                                const qrSize = 280;
                                const qrData = encodeURIComponent(ticket.qrCode);
                                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${qrData}`;
                                
                                qrContainer.innerHTML = `
                                    <img src="${qrUrl}" alt="QR Code" style="width: 200px; height: 200px; display: block;" />
                                `;
                            }
                        } catch (error) {
                            console.error('QR kod fel:', error);
                            // Sista fallback - anv√§nd online QR generator
                            const qrSize = 200;
                            const qrData = encodeURIComponent(ticket.qrCode);
                            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${qrData}`;
                            
                            qrContainer.innerHTML = `
                                <img src="${qrUrl}" alt="QR Code" style="width: 200px; height: 200px; display: block;" 
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'text-align: center; padding: 20px;\\'><div style=\\'font-size: 80px;\\'>‚¨õ</div><div style=\\'font-size: 11px; color: #6b7280; margin-top: 10px;\\'>QR-kod: ${ticket.id}</div></div>';" />
                            `;
                        }
                    }
                });
            }, 200);
        }

        // Render demo buttons
        function renderDemoButtons() {
            const container = document.getElementById('demoButtons');
            
            if (tickets.length === 0) {
                container.innerHTML = `
                    <h3>üß™ Demo - Testa validering</h3>
                    <p style="font-size: 14px; color: #6b7280; margin-top: 10px;">Inga biljetter att testa. K√∂p en biljett f√∂rst!</p>
                `;
                return;
            }

            const html = `
                <h3>üß™ Demo - Testa validering</h3>
                <div style="margin-top: 15px;">
                    ${tickets.slice(0, 3).map(ticket => `
                        <button class="demo-btn" onclick="validateTicket('${ticket.id}')">
                            <div class="demo-btn-title">${ticket.eventName}</div>
                            <div class="demo-btn-subtitle">${ticket.customer.firstName} - ${ticket.id}</div>
                        </button>
                    `).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Search ticket
        function searchTicket() {
            const query = document.getElementById('searchQuery').value.trim().toLowerCase();
            
            if (!query) {
                alert('‚ùå Ange s√∂kkriterier');
                return;
            }

            const ticket = tickets.find(t => 
                t.id.toLowerCase().includes(query) ||
                t.customer.email.toLowerCase().includes(query) ||
                t.customer.phone.includes(query) ||
                t.qrCode.toLowerCase().includes(query)
            );

            if (ticket) {
                validateTicket(ticket.id);
            } else {
                showScanResult(false, 'Ingen biljett hittades', 'Kontrollera s√∂kkriterier och f√∂rs√∂k igen', null);
            }
        }

        // Validate ticket
        function validateTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);

            if (!ticket) {
                showScanResult(false, 'Ogiltig biljett', 'Biljetten kunde inte hittas i systemet', null);
                return;
            }

            if (checkedInTickets.has(ticket.id)) {
                showScanResult(false, 'Redan incheckad', 'Biljetten anv√§ndes redan', ticket);
                return;
            }

            if (ticket.status !== 'active') {
                showScanResult(false, 'Inaktiv biljett', 'Denna biljett √§r inte l√§ngre giltig', ticket);
                return;
            }

            // Check in
            checkedInTickets.add(ticket.id);
            saveData();
            updateCounts();
            renderMyTickets();
            renderCheckinList();

            showScanResult(true, 'V√§lkommen!', 'Biljett godk√§nd', ticket);
        }

        // Validate ticket with QR data - visar fullst√§ndig information
        function validateTicketWithQRData(ticket, qrData) {
            if (!ticket) {
                showScanResult(false, 'Ogiltig biljett', 'Biljetten kunde inte hittas i systemet', null);
                return;
            }

            if (checkedInTickets.has(ticket.id)) {
                showScanResultWithDetails(false, 'Redan incheckad', 'Biljetten anv√§ndes redan', ticket, qrData);
                return;
            }

            if (ticket.status !== 'active') {
                showScanResultWithDetails(false, 'Inaktiv biljett', 'Denna biljett √§r inte l√§ngre giltig', ticket, qrData);
                return;
            }

            // Check in
            checkedInTickets.add(ticket.id);
            saveData();
            updateCounts();
            renderMyTickets();
            renderCheckinList();

            showScanResultWithDetails(true, 'V√§lkommen!', 'Biljett godk√§nd', ticket, qrData);
        }

        // Show scan result
        function showScanResult(success, message, details, ticket) {
            const resultClass = success ? 'result-success' : 'result-error';
            const icon = success ? '‚úÖ' : '‚ùå';
            
            let html = `
                <div class="result-box ${resultClass}">
                    <div class="result-icon">${icon}</div>
                    <div class="result-title">${message}</div>
                    <p style="color: inherit; opacity: 0.8;">${details}</p>
            `;

            if (ticket) {
                html += `
                    <div class="result-details">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 10px;">${ticket.eventName}</div>
                        <div style="font-size: 14px; color: #6b7280; line-height: 1.6;">
                            <div>üë§ ${ticket.customer.firstName} ${ticket.customer.lastName}</div>
                            <div>üìß ${ticket.customer.email}</div>
                            <div>üì± ${ticket.customer.phone}</div>
                            <div>üé´ ${ticket.id}</div>
                        </div>
                    </div>
                `;
            }

            html += `
                    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="clearScanResult()">
                        Forts√§tt scanna
                    </button>
                </div>
            `;

            document.getElementById('scanResult').innerHTML = html;
        }

        // Show scan result with detailed QR data
        function showScanResultWithDetails(success, message, details, ticket, qrData) {
            const resultClass = success ? 'result-success' : 'result-error';
            const icon = success ? '‚úÖ' : '‚ùå';
            
            let html = `
                <div class="result-box ${resultClass}">
                    <div class="result-icon">${icon}</div>
                    <div class="result-title">${message}</div>
                    <p style="color: inherit; opacity: 0.8; margin-bottom: 20px;">${details}</p>
            `;

            if (qrData) {
                // Best√§m betalnings- och validerings-status
                const isPaid = qrData.paymentStatus === 'BETALD' || qrData.paid === true;
                const paymentStatus = isPaid ? 'BETALD' : 'OBETALD';
                const paymentColor = isPaid ? '#22c55e' : '#ef4444'; // Gr√∂n f√∂r betald, r√∂d f√∂r obetald
                const paymentBgColor = isPaid ? '#dcfce7' : '#fee2e2';
                
                const validStatus = success ? 'GODK√ÑND' : (checkedInTickets.has(ticket?.id) ? 'REDAN ANV√ÑND' : 'OGILTIG');
                const validColor = success ? '#22c55e' : '#ef4444';
                const validBgColor = success ? '#dcfce7' : '#fee2e2';

                html += `
                    <!-- BETALNINGSSTATUS - MYCKET SYNLIG MED F√ÑRGKODNING -->
                    <div style="background: ${paymentBgColor}; border: 4px solid ${paymentColor}; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: ${paymentColor};">
                                ${isPaid ? 'üí≥‚úÖ' : 'üí≥‚ùå'} ${paymentStatus}
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: ${validColor}; margin-top: 8px;">
                                ${success ? '‚úÖ' : '‚ùå'} ${validStatus}
                            </div>
                        </div>
                    </div>

                    <div class="result-details" style="text-align: left;">
                        <!-- ANTAL PERSONER - MYCKET SYNLIG -->
                        <div style="background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 22px; font-weight: bold; margin-bottom: 12px;">
                                üë• TOTALT: ${qrData.totalPersons} PERSON${qrData.totalPersons > 1 ? 'ER' : ''}
                            </div>
                            <div style="font-size: 18px; line-height: 1.8;">
                                ${qrData.adults > 0 ? `<div>üë® Vuxna: <strong>${qrData.adults}</strong></div>` : ''}
                                ${qrData.children > 0 ? `<div>üë∂ Barn: <strong>${qrData.children}</strong></div>` : ''}
                            </div>
                        </div>

                        <!-- PRIS INFORMATION -->
                        <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 18px; font-weight: bold; color: #92400e; margin-bottom: 8px;">
                                üí∞ BETALNINGSINFORMATION
                            </div>
                            <div style="font-size: 16px; color: #78350f; line-height: 1.8;">
                                <div>Denna biljett (${qrData.type}): <strong>${qrData.price} kr</strong></div>
                                ${qrData.totalPrice ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #f59e0b; font-size: 18px;"><strong>TOTALT F√ñR GRUPPEN (${qrData.totalPersons} pers): ${qrData.totalPrice} kr</strong></div>` : ''}
                                ${qrData.adults > 0 ? `<div style="font-size: 14px; margin-top: 5px;">Inkl. ${qrData.adults} vuxen${qrData.adults > 1 ? 'a' : ''}</div>` : ''}
                                ${qrData.children > 0 ? `<div style="font-size: 14px;">Inkl. ${qrData.children} barn</div>` : ''}
                            </div>
                        </div>

                        <!-- EVENT INFORMATION -->
                        <div style="background: white; border: 2px solid #e5e7eb; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 18px; margin-bottom: 10px;">
                                üé≠ ${qrData.event}
                            </div>
                            <div style="font-size: 14px; color: #6b7280; line-height: 1.8;">
                                <div><strong>üìÖ Datum:</strong> ${qrData.date} kl. ${qrData.time}</div>
                                <div><strong>üé´ Biljetttyp:</strong> ${qrData.type}</div>
                            </div>
                        </div>

                        <!-- KUNDINFORMATION -->
                        <div style="background: white; border: 2px solid #e5e7eb; padding: 15px; border-radius: 12px;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 16px; margin-bottom: 10px;">
                                üë§ KUNDINFORMATION
                            </div>
                            <div style="font-size: 14px; color: #6b7280; line-height: 1.8;">
                                <div><strong>Namn:</strong> ${qrData.customer}</div>
                                <div><strong>üìß E-post:</strong> ${qrData.email}</div>
                                <div><strong>üì± Telefon:</strong> ${qrData.phone}</div>
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                    <strong>üÜî Biljett-ID:</strong><br>
                                    <span style="font-family: monospace; font-size: 11px; word-break: break-all;">${qrData.ticketId}</span>
                                </div>
                                <div style="margin-top: 5px;">
                                    <strong>üì¶ Grupp-ID:</strong><br>
                                    <span style="font-family: monospace; font-size: 11px; word-break: break-all;">${qrData.groupId}</span>
                                </div>
                                ${qrData.purchaseDate ? `<div style="margin-top: 5px;"><strong>üïê K√∂pt:</strong> ${new Date(qrData.purchaseDate).toLocaleString('sv-SE')}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else if (ticket) {
                html += `
                    <div class="result-details">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 10px;">${ticket.eventName}</div>
                        <div style="font-size: 14px; color: #6b7280; line-height: 1.6;">
                            <div>üë§ ${ticket.customer.firstName} ${ticket.customer.lastName}</div>
                            <div>üìß ${ticket.customer.email}</div>
                            <div>üì± ${ticket.customer.phone}</div>
                            <div>üé´ ${ticket.id}</div>
                            <div style="margin-top: 10px; font-weight: bold; color: #22c55e;">üí≥ ${ticket.paymentStatus || 'BETALD'}</div>
                        </div>
                    </div>
                `;
            }

            html += `
                    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="clearScanResult()">
                        Forts√§tt scanna
                    </button>
                </div>
            `;

            document.getElementById('scanResult').innerHTML = html;
        }

        // Clear scan result
        function clearScanResult() {
            document.getElementById('scanResult').innerHTML = '';
            document.getElementById('searchQuery').value = '';
        }

        // QR Scanner
        let html5QrCode = null;
        let isScanning = false;

        function startScanner() {
            if (isScanning) return;

            const qrReader = document.getElementById('qr-reader');
            const placeholder = document.getElementById('scannerPlaceholder');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');

            qrReader.style.display = 'block';
            placeholder.style.display = 'none';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';

            html5QrCode = new Html5Qrcode("qr-reader");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText, decodedResult) => {
                    // QR kod skannad!
                    console.log('QR kod skannad:', decodedText);
                    
                    // F√∂rs√∂k parsa JSON-data fr√•n QR-koden
                    try {
                        const qrData = JSON.parse(decodedText);
                        // Hitta biljett baserat p√• ticketId fr√•n QR-koden
                        const ticket = tickets.find(t => t.id === qrData.ticketId);
                        
                        if (ticket) {
                            stopScanner();
                            validateTicketWithQRData(ticket, qrData);
                        } else {
                            showScanResult(false, 'Biljett ej hittad', 'Denna QR-kod √§r inte registrerad i systemet', null);
                        }
                    } catch (e) {
                        // Om det inte √§r JSON, f√∂rs√∂k hitta med vanlig s√∂kning
                        const ticket = tickets.find(t => 
                            t.qrCode.includes(decodedText) || 
                            t.id === decodedText ||
                            decodedText.includes(t.id)
                        );
                        
                        if (ticket) {
                            stopScanner();
                            validateTicket(ticket.id);
                        } else {
                            showScanResult(false, 'Ok√§nd QR-kod', 'Denna QR-kod tillh√∂r ingen biljett', null);
                        }
                    }
                },
                (errorMessage) => {
                    // Scanning error (ignoreras f√∂r att inte spamma)
                }
            ).catch((err) => {
                console.error('Kamera-fel:', err);
                alert('‚ùå Kunde inte starta kameran. Kontrollera att du gett till√•telse att anv√§nda kameran.');
                stopScanner();
            });

            isScanning = true;
        }

        function stopScanner() {
            if (!html5QrCode || !isScanning) return;

            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                html5QrCode = null;
                isScanning = false;

                const qrReader = document.getElementById('qr-reader');
                const placeholder = document.getElementById('scannerPlaceholder');
                const startBtn = document.getElementById('startCameraBtn');
                const stopBtn = document.getElementById('stopCameraBtn');

                qrReader.style.display = 'none';
                placeholder.style.display = 'block';
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }).catch((err) => {
                console.error('Fel vid stoppning av kamera:', err);
            });
        }

        // Render check-in list
        function renderCheckinList() {
            const container = document.getElementById('checkinList');
            const checkedInList = tickets.filter(t => checkedInTickets.has(t.id));

            if (checkedInList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <p class="empty-text">Inga g√§ster har checkats in √§n</p>
                    </div>
                `;
                return;
            }

            const html = checkedInList.map(ticket => `
                <div class="guest-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div class="guest-name">${ticket.customer.firstName} ${ticket.customer.lastName}</div>
                            <div class="guest-event">${ticket.eventName}</div>
                            <div class="guest-contact">
                                üìß ${ticket.customer.email}<br>
                                üì± ${ticket.customer.phone}
                            </div>
                        </div>
                        <div style="color: #22c55e; font-size: 24px;">‚úÖ</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Delete ticket function
        function deleteTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;

            const confirmMsg = `√Ñr du s√§ker p√• att du vill radera denna biljett?\n\n${ticket.eventName}\n${ticket.customer.firstName} ${ticket.customer.lastName}\n${ticket.ticketType} - ${ticket.price} kr`;
            
            if (!confirm(confirmMsg)) return;

            // Ta bort biljetten
            tickets = tickets.filter(t => t.id !== ticketId);
            
            // Ta bort fr√•n incheckade om den var incheckad
            if (checkedInTickets.has(ticketId)) {
                checkedInTickets.delete(ticketId);
            }

            // L√§gg tillbaka biljett till tillg√§ngliga
            const event = events.find(e => e.id === ticket.eventId);
            if (event) {
                event.availableTickets++;
            }

            saveData();
            updateCounts();
            renderEvents();
            renderMyTickets();
            renderCheckinList();
            renderDemoButtons();

            alert('‚úÖ Biljett raderad!');
        }

        // Resend ticket email
        async function resendTicketEmail(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) {
                alert('‚ùå Biljett hittades inte');
                return;
            }

            const confirmMsg = `Skicka biljett via e-post till:\n\n${ticket.customer.email}\n\nF√∂r ${ticket.eventName}?`;
            if (!confirm(confirmMsg)) return;

            // Visa laddningsmeddelande
            alert('üìß Skickar e-post...');

            const sent = await sendTicketEmail(ticket);
            
            if (sent) {
                alert(`‚úÖ Biljett skickad till:\n${ticket.customer.email}\n\nKontrollera din inkorg!`);
            } else {
                alert(`‚ùå Kunde inte skicka e-post.\n\nOBS: F√∂r att aktivera automatisk e-post, konfigurera EmailJS.\n\nG√• till https://www.emailjs.com/ och skapa ett konto.\n\nTills dess kan du ladda ner biljetten som PDF.`);
            }
        }

        // Download ticket as PDF
        async function downloadTicketPDF(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) {
                alert('‚ùå Biljett hittades inte');
                return;
            }

            try {
                const doc = await generateTicketPDF(ticket);
                if (!doc) return;

                // Spara PDF
                const fileName = `Biljett-${ticket.eventName.replace(/[^a-zA-Z0-9]/g, '_')}-${ticket.id}.pdf`;
                doc.save(fileName);

                alert('‚úÖ PDF nedladdad!');

            } catch (error) {
                console.error('PDF fel:', error);
                alert('‚ùå Kunde inte skapa PDF. F√∂rs√∂k igen.');
            }
        }

        // Generate PDF for ticket (returnerar jsPDF objekt)
        async function generateTicketPDF(ticket) {
            try {
                // Kontrollera om jsPDF √§r laddat
                if (typeof window.jspdf === 'undefined') {
                    alert('‚ùå PDF-biblioteket kunde inte laddas. F√∂rs√∂k igen.');
                    return null;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Betalningsstatus
                const isPaid = ticket.paid || ticket.paymentStatus === 'BETALD';
                const paymentStatus = isPaid ? 'BETALD' : 'OBETALD';
                const paymentColor = isPaid ? [34, 197, 94] : [239, 68, 68];

                // === HEADER MED BAKGRUND ===
                doc.setFillColor(147, 51, 234); // Lila
                doc.rect(0, 0, 210, 55, 'F');

                // Titel
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(32);
                doc.setFont(undefined, 'bold');
                doc.text('EVENT BILJETT', 105, 25, { align: 'center' });

                // Event namn
                doc.setFontSize(22);
                doc.text(ticket.eventName, 105, 42, { align: 'center' });

                // === BETALNINGSSTATUS BOX ===
                doc.setFillColor(paymentColor[0], paymentColor[1], paymentColor[2]);
                doc.roundedRect(50, 62, 110, 18, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(paymentStatus, 105, 74, { align: 'center' });

                // === DATUM OCH PLATS BOX ===
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(15, 88, 180, 22, 2, 2, 'F');
                doc.setTextColor(60, 60, 60);
                doc.setFontSize(13);
                doc.setFont(undefined, 'normal');
                doc.text(`Datum: ${ticket.eventDate} kl. ${ticket.eventTime}`, 20, 97);
                doc.text(`Plats: ${ticket.eventLocation}`, 20, 106);

                // === KUNDINFORMATION ===
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(15, 117, 180, 38, 2, 2, 'F');
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.5);
                doc.roundedRect(15, 117, 180, 38, 2, 2, 'S');
                
                doc.setTextColor(147, 51, 234);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('KUNDINFORMATION', 20, 126);
                
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                doc.text(`Namn: ${ticket.customer.firstName} ${ticket.customer.lastName}`, 25, 135);
                doc.text(`E-post: ${ticket.customer.email}`, 25, 142);
                doc.text(`Telefon: ${ticket.customer.phone}`, 25, 149);

                // === BILJETTINFORMATION ===
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(15, 162, 180, 45, 2, 2, 'F');
                doc.setDrawColor(220, 220, 220);
                doc.roundedRect(15, 162, 180, 45, 2, 2, 'S');
                
                doc.setTextColor(147, 51, 234);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('BILJETTINFORMATION', 20, 171);
                
                doc.setTextColor(40, 40, 40);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                doc.text(`Typ: ${ticket.ticketType || 'Standard'}`, 25, 180);
                doc.text(`Pris: ${ticket.price} kr`, 25, 187);
                
                // Gruppinformation
                if (ticket.bookingInfo) {
                    doc.text(`Antal personer: ${ticket.bookingInfo.totalPersons} (${ticket.bookingInfo.adults} vuxna, ${ticket.bookingInfo.children} barn)`, 25, 194);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Totalt pris for gruppen: ${ticket.bookingInfo.totalPrice} kr`, 25, 201);
                }

                // === BILJETT-ID OCH GRUPP-ID ===
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(15, 214, 87, 10, 2, 2, 'F');
                doc.roundedRect(108, 214, 87, 10, 2, 2, 'F');
                
                doc.setTextColor(80, 80, 80);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text(`Biljett-ID: ${ticket.id}`, 18, 221);
                if (ticket.groupId) {
                    doc.text(`Grupp-ID: ${ticket.groupId}`, 111, 221);
                }

                // === QR-KOD ===
                doc.setTextColor(40, 40, 40);
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('Visa QR-kod vid entr√©n:', 105, 232, { align: 'center' });
                
                // Vit bakgrund f√∂r QR-kod
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(60, 237, 90, 90, 3, 3, 'F');
                doc.setDrawColor(147, 51, 234);
                doc.setLineWidth(2);
                doc.roundedRect(60, 237, 90, 90, 3, 3, 'S');
                
                try {
                    const qrElement = document.getElementById(`qr-${ticket.id}`);
                    if (qrElement && qrElement.querySelector('img')) {
                        const qrImg = qrElement.querySelector('img');
                        // St√∂rre QR-kod, centrerad i boxen
                        doc.addImage(qrImg.src, 'PNG', 65, 242, 80, 80);
                    } else {
                        // Fallback - generera QR direkt
                        if (typeof qrcode !== 'undefined') {
                            const qr = qrcode(0, 'H');
                            qr.addData(ticket.qrCode || ticket.id);
                            qr.make();
                            const qrImageData = qr.createDataURL(10, 0);
                            doc.addImage(qrImageData, 'PNG', 65, 242, 80, 80);
                        } else {
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'normal');
                            doc.setTextColor(147, 51, 234);
                            doc.text('Visa denna biljett i appen', 105, 280, { align: 'center' });
                        }
                    }
                } catch (qrError) {
                    console.error('QR-kod fel:', qrError);
                }

                // === FOOTER === (Flyttad l√§ngre ner)
                doc.setFillColor(147, 51, 234);
                doc.rect(0, 332, 210, 12, 'F');
                doc.setFontSize(9);
                doc.setTextColor(255, 255, 255);
                doc.text('M√∂lndals Festv√•ning ¬© 2025 | Spara denna biljett | Visa vid entr√©n', 105, 339, { align: 'center' });

                return doc;

            } catch (error) {
                console.error('PDF generering fel:', error);
                return null;
            }
        }

        // Send ticket via email
        async function sendTicketEmail(ticket) {
            try {
                // Generera PDF
                const doc = await generateTicketPDF(ticket);
                if (!doc) {
                    console.error('Kunde inte generera PDF');
                    return false;
                }

                // Konvertera PDF till base64
                const pdfBase64 = doc.output('datauristring').split(',')[1];

                // Betalningsstatus
                const isPaid = ticket.paid || ticket.paymentStatus === 'BETALD';
                const paymentStatus = isPaid ? '‚úÖ BETALD' : '‚ö†Ô∏è OBETALD (Betalas vid entr√©n)';

                // E-post inneh√•ll
                const emailParams = {
                    to_email: ticket.customer.email,
                    to_name: `${ticket.customer.firstName} ${ticket.customer.lastName}`,
                    event_name: ticket.eventName,
                    event_date: ticket.eventDate,
                    event_time: ticket.eventTime,
                    event_location: ticket.eventLocation,
                    ticket_type: ticket.ticketType || 'Standard',
                    ticket_price: ticket.price,
                    ticket_id: ticket.id,
                    payment_status: paymentStatus,
                    total_persons: ticket.bookingInfo ? ticket.bookingInfo.totalPersons : 1,
                    total_price: ticket.bookingInfo ? ticket.bookingInfo.totalPrice : ticket.price,
                    pdf_attachment: pdfBase64,
                    message: `
Hej ${ticket.customer.firstName}!

Tack f√∂r din bokning! üéâ

Din biljett till ${ticket.eventName} √§r nu klar.

üìÖ Datum: ${ticket.eventDate} kl. ${ticket.eventTime}
üìç Plats: ${ticket.eventLocation}
üé´ Biljetttyp: ${ticket.ticketType || 'Standard'}
üí∞ Pris: ${ticket.price} kr
${ticket.bookingInfo ? `üë• Antal personer: ${ticket.bookingInfo.totalPersons} (${ticket.bookingInfo.adults} vuxna, ${ticket.bookingInfo.children} barn)` : ''}
${ticket.bookingInfo ? `üíµ Totalt: ${ticket.bookingInfo.totalPrice} kr` : ''}

${paymentStatus}

Din biljett finns bifogad som PDF. Du kan ocks√• visa biljetten direkt i appen med QR-koden vid entr√©n.

Vi ses p√• eventet!

V√§nliga h√§lsningar,
EventBiljetter
                    `
                };

                // NOTERING: F√∂r att detta ska fungera m√•ste du konfigurera EmailJS
                // 1. Registrera dig p√• https://www.emailjs.com/
                // 2. Skapa en email service
                // 3. Skapa en email template
                // 4. Ers√§tt nycklarna nedan med dina egna

                // Detta √§r en demonstration - ers√§tt med dina nycklar
                if (typeof emailjs !== 'undefined' && emailjs.send) {
                    // Skicka e-post via EmailJS
                    const response = await emailjs.send(
                        'YOUR_SERVICE_ID',  // Ers√§tt med din Service ID
                        'YOUR_TEMPLATE_ID', // Ers√§tt med din Template ID
                        emailParams
                    );
                    
                    console.log('E-post skickad!', response);
                    return true;
                } else {
                    // Om EmailJS inte √§r konfigurerat, simulera e-post
                    console.log('E-post (simulerad):', emailParams);
                    console.log('F√∂r att aktivera riktiga e-postutskick, konfigurera EmailJS p√• https://www.emailjs.com/');
                    return true; // Returnera true f√∂r demo
                }

            } catch (error) {
                console.error('E-post fel:', error);
                return false;
            }
        }

        // Admin Functions
        let editingEventId = null;

        function showCreateEvent() {
            document.getElementById('createEventForm').style.display = 'block';
            editingEventId = null;
            clearEventForm();
        }

        function cancelCreateEvent() {
            document.getElementById('createEventForm').style.display = 'none';
            editingEventId = null;
            clearEventForm();
        }

        function clearEventForm() {
            document.getElementById('adminEventName').value = '';
            document.getElementById('adminEventDate').value = '';
            document.getElementById('adminEventTime').value = '';
            document.getElementById('adminEventLocation').value = '';
            document.getElementById('adminEventIcon').value = 'üéâ';
            document.getElementById('adminPriceAdult').value = '';
            document.getElementById('adminPriceChild').value = '';
            document.getElementById('adminAvailableTickets').value = '';
        }

        function saveEvent() {
            const name = document.getElementById('adminEventName').value.trim();
            const date = document.getElementById('adminEventDate').value;
            const time = document.getElementById('adminEventTime').value;
            const location = document.getElementById('adminEventLocation').value.trim();
            const icon = document.getElementById('adminEventIcon').value.trim() || 'üéâ';
            const priceAdult = parseInt(document.getElementById('adminPriceAdult').value);
            const priceChild = parseInt(document.getElementById('adminPriceChild').value);
            const availableTickets = parseInt(document.getElementById('adminAvailableTickets').value);

            if (!name || !date || !time || !location || isNaN(priceAdult) || isNaN(priceChild) || isNaN(availableTickets)) {
                alert('‚ùå V√§nligen fyll i alla f√§lt korrekt');
                return;
            }

            if (editingEventId) {
                // Update existing event
                const index = events.findIndex(e => e.id === editingEventId);
                const existingEvent = events[index];
                
                events[index] = {
                    ...existingEvent,
                    name,
                    date,
                    time,
                    location,
                    image: icon,
                    priceAdult,
                    priceChild,
                    availableTickets,
                    // Uppdatera ticketTypes om de finns
                    ticketTypes: existingEvent.ticketTypes ? existingEvent.ticketTypes.map((type, i) => {
                        if (i === 0) return { ...type, price: priceAdult, available: availableTickets };
                        if (i === 1) return { ...type, price: priceChild, available: availableTickets };
                        return type;
                    }) : [
                        {
                            id: 'standard-adult',
                            name: 'Vuxen',
                            price: priceAdult,
                            icon: 'üë®',
                            available: availableTickets,
                            description: 'Standardbiljett f√∂r vuxna'
                        },
                        {
                            id: 'standard-child',
                            name: 'Barn (0-12 √•r)',
                            price: priceChild,
                            icon: 'üë∂',
                            available: availableTickets,
                            description: 'Barn under 12 √•r'
                        }
                    ]
                };
                alert('‚úÖ Event uppdaterat!');
            } else {
                // Create new event
                const newEvent = {
                    id: Date.now(),
                    name,
                    date,
                    time,
                    location,
                    image: icon,
                    category: 'other', // Default kategori
                    description: '',
                    priceAdult,
                    priceChild,
                    availableTickets,
                    ticketTypes: [
                        {
                            id: 'standard-adult',
                            name: 'Vuxen',
                            price: priceAdult,
                            icon: 'üë®',
                            available: availableTickets,
                            description: 'Standardbiljett f√∂r vuxna'
                        },
                        {
                            id: 'standard-child',
                            name: 'Barn (0-12 √•r)',
                            price: priceChild,
                            icon: 'üë∂',
                            available: availableTickets,
                            description: 'Barn under 12 √•r'
                        }
                    ]
                };
                events.push(newEvent);
                alert('‚úÖ Nytt event skapat!');
            }

            saveData();
            updateCounts();
            renderEvents();
            renderAdminEvents();
            cancelCreateEvent();
        }

        function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            editingEventId = eventId;
            document.getElementById('adminEventName').value = event.name;
            document.getElementById('adminEventDate').value = event.date;
            document.getElementById('adminEventTime').value = event.time;
            document.getElementById('adminEventLocation').value = event.location;
            document.getElementById('adminEventIcon').value = event.image;
            document.getElementById('adminPriceAdult').value = event.priceAdult;
            document.getElementById('adminPriceChild').value = event.priceChild;
            document.getElementById('adminAvailableTickets').value = event.availableTickets;

            document.getElementById('createEventForm').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function deleteEvent(eventId) {
            if (!confirm('√Ñr du s√§ker p√• att du vill ta bort detta event?')) return;

            events = events.filter(e => e.id !== eventId);
            saveData();
            updateCounts();
            renderEvents();
            renderAdminEvents();
            alert('‚úÖ Event borttaget!');
        }

        function renderAdminEvents() {
            const html = events.map(event => `
                <div class="event-card">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="font-size: 40px;">${event.image}</div>
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 5px;">${event.name}</h3>
                            <div style="font-size: 14px; color: #6b7280;">
                                üìÖ ${event.date} kl. ${event.time}<br>
                                üìç ${event.location}<br>
                                üë® Vuxen: ${event.priceAdult} kr | üë∂ Barn: ${event.priceChild} kr<br>
                                üé´ ${event.availableTickets} biljetter
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" style="flex: 1; background: #3b82f6; color: white;" onclick="editEvent(${event.id})">
                            ‚úèÔ∏è Redigera
                        </button>
                        <button class="btn" style="flex: 1; background: #ef4444; color: white;" onclick="deleteEvent(${event.id})">
                            üóëÔ∏è Ta bort
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('adminEventsList').innerHTML = html;
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            // Kontrollera om QRCode biblioteket laddades
            if (typeof QRCode === 'undefined') {
                console.error('QRCode biblioteket kunde inte laddas!');
            } else {
                console.log('QRCode biblioteket laddat!');
            }
            
            // Initiera EmailJS (Du kan anv√§nda demo keys eller konfigurera egna)
            // F√∂r att detta ska fungera m√•ste du registrera dig p√• emailjs.com och f√• dina egna nycklar
            if (typeof emailjs !== 'undefined') {
                // Demo keys - byt ut mot dina egna fr√•n emailjs.com
                emailjs.init("YOUR_PUBLIC_KEO13hGSHD6MPrrShWp"); // Ers√§tt med din public key
                console.log('EmailJS initierat (konfigurera med dina nycklar f√∂r att aktivera)');
            }
            
            init();
        });
    </script>
</body>
</html>